<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Articint | Project Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-card {
            transition: background-color 0.2s, box-shadow 0.2s, transform 0.2s;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .task-card.dragging {
            opacity: 0.5;
            transform: rotate(3deg) scale(1.05);
        }
        .progress-bar-inner, .xp-bar-inner {
            transition: width 0.5s ease-in-out;
        }
        .phase-badge {
            display: inline-block;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            margin-right: 8px;
        }
        .tab-btn {
            transition: all 0.2s;
        }
        .tab-btn.active {
            color: #2563eb; /* text-blue-600 */
            border-bottom-color: #2563eb; /* border-blue-600 */
        }
    </style>
</head>
<body class="bg-slate-100">

    <div class="container mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-12">
        <!-- Dashboard Header -->
        <header class="mb-8 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-4xl font-bold text-slate-800">Project Progress Dashboard</h1>
                <p class="mt-2 text-slate-600">Your 90-Day Sprint to $10,000/month MRR.</p>
            </div>
            <!-- Gamification Stats -->
            <div class="bg-white p-4 rounded-lg shadow-sm border border-slate-200">
                <div class="flex items-center gap-4">
                    <div id="level-badge" class="h-16 w-16 bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex flex-col items-center justify-center rounded-full shadow-lg">
                        <span class="text-xs font-bold tracking-wider">LEVEL</span>
                        <span id="level-text" class="text-2xl font-bold">1</span>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-700">Next Level</p>
                        <div class="w-48 bg-slate-200 rounded-full h-2.5 mt-1">
                            <div id="xp-bar-inner" class="bg-amber-400 h-2.5 rounded-full xp-bar-inner" style="width: 0%"></div>
                        </div>
                        <p id="xp-text" class="text-xs text-slate-500 mt-1 text-right">0 / 100 XP</p>
                    </div>
                </div>
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between mb-1">
                <span class="text-base font-medium text-blue-700">Overall Task Progress</span>
                <span id="progress-text" class="text-sm font-medium text-blue-700">0%</span>
            </div>
            <div class="w-full bg-slate-200 rounded-full h-4">
                <div id="progress-bar-inner" class="bg-blue-600 h-4 rounded-full progress-bar-inner" style="width: 0%"></div>
            </div>
        </div>
        
        <!-- Add Task Form -->
        <div class="mb-8">
            <form id="add-task-form" class="flex flex-wrap gap-4">
                <input type="text" id="new-task-input" placeholder="Enter a new task..." class="flex-grow p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none min-w-[200px]" required>
                 <select id="new-task-phase" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                    <option value="building">Building Phase</option>
                    <option value="outreach">Outreach Phase</option>
                    <option value="re-evaluating">Re-evaluating Phase</option>
                </select>
                <select id="new-task-priority" class="p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                    <option value="medium">Medium Priority</option>
                    <option value="high">High Priority</option>
                    <option value="low">Low Priority</option>
                </select>
                <button type="submit" class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-lg shadow hover:bg-blue-700 transition-colors">Add Task</button>
            </form>
        </div>

        <!-- Kanban Board Columns -->
        <div id="kanban-board" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- To Do Column -->
            <div id="todo-column" class="task-column bg-white rounded-lg p-4 shadow-inner">
                <h2 class="text-xl font-semibold text-slate-700 mb-2">To Do</h2>
                <!-- Tab Navigation -->
                <div class="border-b border-slate-200 mb-4">
                    <nav id="todo-tabs" class="-mb-px flex space-x-6">
                        <button data-phase="building" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-blue-600 border-transparent">Building</button>
                        <button data-phase="outreach" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-blue-600 border-transparent">Outreach</button>
                        <button data-phase="re-evaluating" class="tab-btn py-2 px-1 border-b-2 font-medium text-sm text-slate-500 hover:text-blue-600 border-transparent">Re-evaluating</button>
                    </nav>
                </div>
                <!-- Task Lists for Tabs -->
                <div id="todo-tasks" class="task-list min-h-[300px] space-y-3 p-1"></div>
            </div>

            <!-- In Progress Column -->
            <div id="inprogress-column" class="task-column bg-white rounded-lg p-4 shadow-inner">
                <h2 class="text-xl font-semibold text-slate-700 mb-4 border-b-2 border-yellow-300 pb-2">In Progress</h2>
                <div id="inprogress-tasks" class="task-list min-h-[300px] space-y-3 p-1"></div>
            </div>

            <!-- Done Column (History) -->
            <div id="done-column" class="task-column bg-white rounded-lg p-4 shadow-inner">
                <div class="flex justify-between items-center mb-4 border-b-2 border-green-300 pb-2">
                    <h2 class="text-xl font-semibold text-slate-700">Done (History)</h2>
                    <button id="clear-done-btn" class="text-xs text-slate-500 hover:text-red-600 transition-colors">Clear All</button>
                </div>
                <div id="done-tasks" class="task-list min-h-[300px] space-y-3 p-1"></div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // --- IMPORTANT ---
        // Replace this URL with your actual Cloudflare Worker URL
        const WORKER_URL = 'https://dashboard-api.houtmc11.workers.dev/';
        // --- IMPORTANT ---

        const todoTasksContainer = document.getElementById('todo-tasks');
        const inProgressTasksContainer = document.getElementById('inprogress-tasks');
        const doneTasksContainer = document.getElementById('done-tasks');
        const addTaskForm = document.getElementById('add-task-form');
        const newTaskInput = document.getElementById('new-task-input');
        const newTaskPhaseSelect = document.getElementById('new-task-phase');
        const newTaskPrioritySelect = document.getElementById('new-task-priority');
        const clearDoneBtn = document.getElementById('clear-done-btn');
        const todoTabsContainer = document.getElementById('todo-tabs');

        let tasks = { todo: [], inprogress: [], done: [] };
        let userProfile = { level: 1, xp: 0 };
        let activeTodoTab = 'building';
        const XP_PER_LEVEL = 1000;

        const PHASE_CONFIG = { /* ... config objects ... */ };
        const PRIORITY_CONFIG = { /* ... config objects ... */ };
        
        // Populate config objects
        Object.assign(PHASE_CONFIG, {
            building: { color: 'bg-indigo-100 text-indigo-800', name: 'Building' },
            outreach: { color: 'bg-rose-100 text-rose-800', name: 'Outreach' },
            're-evaluating': { color: 'bg-teal-100 text-teal-800', name: 'Re-evaluating' }
        });
        Object.assign(PRIORITY_CONFIG, {
            high: { color: 'text-red-500', name: 'High', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>' },
            medium: { color: 'text-yellow-500', name: 'Medium', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>' },
            low: { color: 'text-green-500', name: 'Low', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1.293-9.293a1 1 0 00-1.414 0L9 10.586V7a1 1 0 10-2 0v3.586l-1.293-1.293a1 1 0 10-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 000-1.414z" clip-rule="evenodd" /></svg>' }
        });


        const loadData = async () => {
            // Load tasks from Cloudflare D1 via the Worker
            try {
                const response = await fetch(`${WORKER_URL}/api/tasks`);
                if (!response.ok) throw new Error('Failed to fetch tasks');
                const dbTasks = await response.json();
                
                // Reset local task state
                tasks = { todo: [], inprogress: [], done: [] };
                
                if (dbTasks && dbTasks.length > 0) {
                    dbTasks.forEach(task => {
                        tasks[task.status].push(task);
                    });
                } else if (!localStorage.getItem('initialTasksLoaded')) {
                    // First time load, populate with initial tasks
                    tasks = getInitialTasks();
                    await saveData();
                    localStorage.setItem('initialTasksLoaded', 'true');
                }
            } catch (error) {
                console.error("Error loading tasks:", error);
                // Optionally handle UI feedback for the user
            }
            
            // Load user profile from localStorage (gamification is local for now)
            const savedProfile = localStorage.getItem('dashboardProfileV2');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
            } else {
                recalculateXP();
            }
        };

        const saveData = async () => {
            // Save tasks to Cloudflare D1 via the Worker
            const allTasksFlat = Object.keys(tasks).flatMap(status => 
                tasks[status].map(task => ({ ...task, status }))
            );

            try {
                await fetch(`${WORKER_URL}/api/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(allTasksFlat),
                });
            } catch (error) {
                console.error("Error saving tasks:", error);
            }

            // Save user profile to localStorage
            localStorage.setItem('dashboardProfileV2', JSON.stringify(userProfile));
        };
        
        const createTaskElement = (task) => {
            const card = document.createElement('div');
            card.className = `task-card bg-slate-50 p-3 rounded-lg border-l-4 ${task.priority === 'high' ? 'border-red-400' : 'border-slate-200'} cursor-grab flex flex-col`;
            card.setAttribute('draggable', 'true');
            card.setAttribute('data-task-id', task.id);

            const phaseConfig = PHASE_CONFIG[task.phase] || { color: 'bg-slate-200 text-slate-800', name: 'Misc' };
            const priorityConfig = PRIORITY_CONFIG[task.priority] || PRIORITY_CONFIG.medium;

            let innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="text-slate-800 text-sm flex-grow pr-2">${task.content}</p>
                    <button data-task-id="${task.id}" class="delete-task-btn text-slate-400 hover:text-red-500 shrink-0">&times;</button>
                </div>
                <div class="flex items-center justify-between mt-3 pt-2 border-t border-slate-200">
                    <div class="flex items-center gap-2">
                         <span class="phase-badge ${phaseConfig.color}">${phaseConfig.name}</span>
                         <span title="${priorityConfig.name} Priority" class="${priorityConfig.color}">${priorityConfig.icon}</span>
                    </div>
                    <span class="text-xs font-bold text-amber-500">${task.xp} XP</span>
                </div>
            `;

            if (task.completed_at) {
                card.classList.add('opacity-80', 'bg-green-50');
                innerHTML += `<p class="text-xs text-slate-400 mt-1">Completed: ${new Date(task.completed_at).toLocaleDateString()}</p>`;
            }

            card.innerHTML = innerHTML;
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);
            card.querySelector('.delete-task-btn').addEventListener('click', handleDeleteTask);
            return card;
        };
        
        const sortTasks = (taskArray) => {
            const priorityOrder = { high: 3, medium: 2, low: 1 };
            return taskArray.sort((a, b) => (priorityOrder[b.priority] || 0) - (priorityOrder[a.priority] || 0));
        };

        const renderAll = () => {
            todoTasksContainer.innerHTML = '';
            inProgressTasksContainer.innerHTML = '';
            doneTasksContainer.innerHTML = '';

            sortTasks(tasks.todo)
                .filter(task => task.phase === activeTodoTab)
                .forEach(task => todoTasksContainer.appendChild(createTaskElement(task)));

            sortTasks(tasks.inprogress)
                .forEach(task => inProgressTasksContainer.appendChild(createTaskElement(task)));

            tasks.done.forEach(task => doneTasksContainer.appendChild(createTaskElement(task)));

            updateTabStyles();
            updateProgressBar();
            updateGamification();
        };

        const updateTabStyles = () => {
            todoTabsContainer.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.phase === activeTodoTab);
            });
        };

        const updateProgressBar = () => {
            const allTasks = [...tasks.todo, ...tasks.inprogress, ...tasks.done];
            const doneCount = tasks.done.length;
            const totalTasks = allTasks.length;
            const percentage = totalTasks > 0 ? (doneCount / totalTasks) * 100 : 0;
            document.getElementById('progress-bar-inner').style.width = `${percentage}%`;
            document.getElementById('progress-text').textContent = `${Math.round(percentage)}%`;
        };
        
        const recalculateXP = () => {
            userProfile.xp = tasks.done.reduce((acc, task) => acc + (task.xp || 0), 0);
        };

        const updateGamification = () => {
            userProfile.level = Math.floor(userProfile.xp / XP_PER_LEVEL) + 1;
            const xpForCurrentLevel = userProfile.xp % XP_PER_LEVEL;
            const xpPercentage = (xpForCurrentLevel / XP_PER_LEVEL) * 100;
            
            document.getElementById('level-text').textContent = userProfile.level;
            document.getElementById('xp-text').textContent = `${xpForCurrentLevel} / ${XP_PER_LEVEL} XP`;
            document.getElementById('xp-bar-inner').style.width = `${xpPercentage}%`;
        };

        // --- Event Listeners ---
        
        todoTabsContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-btn')) {
                activeTodoTab = e.target.dataset.phase;
                renderAll();
            }
        });

        addTaskForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const taskContent = newTaskInput.value.trim();
            if (!taskContent) return;
            
            const newTask = {
                id: Date.now(),
                content: taskContent,
                phase: newTaskPhaseSelect.value,
                priority: newTaskPrioritySelect.value,
                xp: 50
            };
            tasks.todo.push(newTask);
            activeTodoTab = newTask.phase;
            await saveData();
            renderAll();
            newTaskInput.value = '';
        });
        
        clearDoneBtn.addEventListener('click', async () => {
            if(confirm('Are you sure you want to clear all completed tasks? This cannot be undone.')) {
                tasks.done = [];
                recalculateXP();
                await saveData();
                renderAll();
            }
        });

        const handleDeleteTask = async (e) => {
            e.stopPropagation();
            const taskId = parseInt(e.currentTarget.dataset.taskId);
            for (const columnKey in tasks) {
                const taskIndex = tasks[columnKey].findIndex(t => t.id === taskId);
                if (taskIndex > -1) {
                    if(columnKey === 'done') {
                        userProfile.xp -= tasks[columnKey][taskIndex].xp || 0;
                    }
                    tasks[columnKey].splice(taskIndex, 1);
                    await saveData();
                    renderAll();
                    return;
                }
            }
        };

        // --- Drag and Drop ---
        
        let draggedItem = null;
        const handleDragStart = (e) => {
            draggedItem = e.target;
            setTimeout(() => draggedItem.classList.add('dragging'), 0);
        };
        const handleDragEnd = () => {
            if (draggedItem) draggedItem.classList.remove('dragging');
            draggedItem = null;
        };
        
        [todoTasksContainer, inProgressTasksContainer, doneTasksContainer].forEach(column => {
            column.addEventListener('dragover', e => e.preventDefault());
            column.addEventListener('drop', async (e) => {
                e.preventDefault();
                if (!draggedItem) return;

                const taskId = parseInt(draggedItem.dataset.taskId);
                const sourceColumnElement = draggedItem.closest('.task-column');
                const targetColumnElement = e.target.closest('.task-column');
                
                if (!targetColumnElement) return;

                const sourceColumnId = sourceColumnElement.id.replace('-column', '');
                const targetColumnId = targetColumnElement.id.replace('-column', '');
                
                let taskToMove;
                const sourceArray = tasks[sourceColumnId];
                const taskIndex = sourceArray.findIndex(t => t.id === taskId);
                
                if (taskIndex === -1) return;
                
                taskToMove = sourceArray.splice(taskIndex, 1)[0];
                
                if (targetColumnId === 'done' && sourceColumnId !== 'done') {
                    taskToMove.completed_at = new Date().toISOString();
                    userProfile.xp += taskToMove.xp || 0;
                } else if (sourceColumnId === 'done' && targetColumnId !== 'done') {
                    delete taskToMove.completed_at;
                    userProfile.xp -= taskToMove.xp || 0;
                }

                tasks[targetColumnId].push(taskToMove);
                await saveData();
                renderAll();
            });
        });

        function getInitialTasks() {
             return {
                todo: [
                    // Building Phase
                    { id: 1, phase: 'building', priority: 'high', xp: 10, content: "Sign up for DigitalOcean account." },
                    { id: 2, phase: 'building', priority: 'high', xp: 20, content: "Provision a basic Droplet with Ubuntu." },
                    { id: 6, phase: 'building', priority: 'high', xp: 50, content: "Deploy n8n using Docker Compose with Postgres." },
                    { id: 13, phase: 'building', priority: 'high', xp: 60, content: "Build the 'Zero-Delay' Client Onboarding workflow." },
                    { id: 3, phase: 'building', priority: 'medium', xp: 30, content: "Install Docker and Docker Compose on the Droplet." },
                    { id: 4, phase: 'building', priority: 'medium', xp: 10, content: "Purchase `articint.com` domain." },
                    { id: 8, phase: 'building', priority: 'medium', xp: 30, content: "Design and build `Clients` table schema in Airtable." },
                    { id: 14, phase: 'building', priority: 'medium', xp: 80, content: "Build the 'Always-On' Reporting workflow." },
                    { id: 5, phase: 'building', priority: 'low', xp: 20, content: "Configure DNS to point subdomain to Droplet." },
                    { id: 7, phase: 'building', priority: 'low', xp: 30, content: "Secure n8n with SSL (Caddy/Nginx)." },
                    { id: 9, phase: 'building', priority: 'low', xp: 40, content: "Build the `[Master] Error Handler` workflow in n8n." },
                    { id: 10, phase: 'building', priority: 'low', xp: 20, content: "Write the Client Welcome Email template." },
                    
                    // Outreach Phase
                    { id: 18, phase: 'outreach', priority: 'high', xp: 100, content: "Build lead list of 500+ contacts matching ICP." },
                    { id: 21, phase: 'outreach', priority: 'high', xp: 200, content: "Launch high-volume outreach campaign (100+/day)." },
                    { id: 23, phase: 'outreach', priority: 'high', xp: 500, content: "MAJOR MILESTONE: Close the first client." },
                    { id: 17, phase: 'outreach', priority: 'medium', xp: 30, content: "Define Ideal Client Profile (ICP) for Marketing Agencies." },
                    { id: 19, phase: 'outreach', priority: 'medium', xp: 50, content: "Write main cold email sequence (3-5 emails)." },
                    { id: 22, phase: 'outreach', priority: 'medium', xp: 100, content: "Conduct the first 10 discovery calls." },
                    { id: 16, phase: 'outreach', priority: 'low', xp: 20, content: "Sign up for outreach tools (e.g., Apollo.io)." },
                    { id: 20, phase: 'outreach', priority: 'low', xp: 30, content: "Warm up new email domain for 2 weeks." },

                    // Re-evaluating Phase
                    { id: 24, phase: 're-evaluating', priority: 'high', xp: 30, content: "Analyze open/reply rates after 2 weeks of outreach." },
                    { id: 26, phase: 're-evaluating', priority: 'high', xp: 50, content: "Review feedback from first client after onboarding." },
                    { id: 29, phase: 're-evaluating', priority: 'high', xp: 100, content: "Create a case study from the first successful client project." },
                    { id: 25, phase: 're-evaluating', priority: 'medium', xp: 40, content: "Listen to recordings of first 5 sales calls." },
                    { id: 28, phase: 're-evaluating', priority: 'medium', xp: 40, content: "Refine the discovery call script." },
                    { id: 27, phase: 're-evaluating', priority: 'low', xp: 30, content: "A/B test a new email subject line." }
                ],
                inprogress: [
                    { id: 30, phase: 'building', priority: 'high', xp: 10, content: "Set up professional email `name@articint.com`." }
                ],
                done: [
                    { id: 31, phase: 'building', priority: 'high', xp: 20, completed_at: new Date().toISOString(), content: "Define the core offer: The Agency Profit Engine." }
                ]
            };
        }

        // --- Initial Load ---
        await loadData();
        renderAll();
    });
    </script>
</body>
</html>
